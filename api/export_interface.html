<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportador de Mensagens WhatsApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados para o scroll e apar√™ncia */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .scrollable-output, .message-preview {
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap; /* Mant√©m a formata√ß√£o do texto (quebras de linha) */
            word-wrap: break-word; /* Garante que linhas longas quebrem */
        }
        .status-ready {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Exportador WhatsApp Simplificado</h1>
        <p class="text-gray-600 mb-6">Gere um arquivo TXT de todas as mensagens trocadas com um contato em um dia espec√≠fico.</p>

        <!-- Status da API -->
        <div id="api-status" class="status-error p-3 rounded-lg text-center font-semibold transition duration-300 mb-6">
            üî¥ API N√ÉO CONECTADA. Aguardando...
        </div>

        <form id="export-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Campo ID do Contato -->
                <div>
                    <label for="chatIdInput" class="block text-sm font-medium text-gray-700 mb-1">ID do Chat / Contato (Apenas N√∫meros)</label>
                    <input type="text" id="chatIdInput" name="chatId" required 
                           placeholder="Ex: 5511987654321"
                           pattern="[0-9]*"
                           title="Apenas n√∫meros s√£o permitidos, sem caracteres especiais."
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Insira apenas os d√≠gitos. O sufixo '@c.us' ser√° adicionado automaticamente.</p>
                </div>
                
                <!-- Campo Data -->
                <div>
                    <label for="dateInput" class="block text-sm font-medium text-gray-700 mb-1">Data de Exporta√ß√£o (Obrigat√≥rio)</label>
                    <input type="date" id="dateInput" name="date" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" id="submit-button"
                        class="w-full sm:w-2/3 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:opacity-50"
                        disabled>
                    <span id="button-text">INICIAR EXPORTA√á√ÉO</span>
                    <div id="loading-spinner" class="loading-spinner ml-3 hidden"></div>
                </button>
                <button type="button" id="fetch-chats-button"
                        class="w-full sm:w-1/3 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-300 transition duration-150 disabled:opacity-50"
                        disabled>
                    Passo 1: Listar Chats
                </button>
            </div>
        </form>

        <hr class="my-8">

        <!-- √Årea de Listagem de Chats -->
        <div id="chat-list-area" class="mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Chats Encontrados (Clique para usar o ID)</h2>
            <div id="chat-list" class="bg-gray-50 p-4 rounded-lg border border-gray-200 scrollable-output">
                <p class="text-gray-500">Clique em "Passo 1: Listar Chats" para carregar.</p>
            </div>
        </div>

        <hr class="my-8">

        <!-- √Årea de Visualiza√ß√£o de Mensagens -->
        <div id="preview-area" class="mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Visualiza√ß√£o de Mensagens (.txt)</h2>
            <div id="download-link-container" class="mb-4 hidden">
                <p class="text-green-600 font-bold">Arquivo gerado! <a id="download-link" href="#" class="text-blue-600 underline hover:text-blue-800">Clique aqui para baixar o TXT</a></p>
            </div>
            <div id="message-preview" class="message-preview bg-gray-900 text-green-400 p-4 rounded-lg border border-gray-700 text-sm">
                Aguardando exporta√ß√£o...
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        const apiStatus = document.getElementById('api-status');
        const submitButton = document.getElementById('submit-button');
        const fetchChatsButton = document.getElementById('fetch-chats-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const chatListDiv = document.getElementById('chat-list');
        const form = document.getElementById('export-form');
        const chatIdInput = document.getElementById('chatIdInput');
        const messagePreview = document.getElementById('message-preview');
        const downloadLinkContainer = document.getElementById('download-link-container');
        const downloadLink = document.getElementById('download-link');

        // --- Fun√ß√µes de Estado e UI ---

        function setStatus(ready, message) {
            if (ready) {
                apiStatus.className = 'status-ready p-3 rounded-lg text-center font-semibold transition duration-300 mb-6';
                submitButton.disabled = false;
                fetchChatsButton.disabled = false;
            } else {
                apiStatus.className = 'status-error p-3 rounded-lg text-center font-semibold transition duration-300 mb-6';
                submitButton.disabled = true;
                fetchChatsButton.disabled = true;
            }
            apiStatus.innerHTML = message;
        }

        function setLoading(isLoading) {
            submitButton.disabled = isLoading || !apiStatus.classList.contains('status-ready');
            fetchChatsButton.disabled = isLoading || !apiStatus.classList.contains('status-ready');
            
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                buttonText.textContent = 'EXPORTANDO...';
                messagePreview.textContent = 'Gerando arquivo TXT no servidor... Por favor, aguarde.';
            } else {
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'INICIAR EXPORTA√á√ÉO';
            }
        }

        // --- L√≥gica de Listagem de Chats ---

        async function fetchChats() {
            chatListDiv.innerHTML = '<p class="text-blue-500">Carregando chats...</p>';
            try {
                const response = await fetch(`${API_URL}/chats`);
                const chats = await response.json();

                if (response.status !== 200) {
                    chatListDiv.innerHTML = `<p class="text-red-600">Erro: ${chats.message || 'Falha ao buscar chats.'}</p>`;
                    return;
                }

                if (chats.length === 0) {
                    chatListDiv.innerHTML = '<p class="text-gray-500">Nenhum chat encontrado ou erro na listagem.</p>';
                    return;
                }

                chatListDiv.innerHTML = '';
                chats.forEach(chat => {
                    // Remove o sufixo @c.us ou @g.us para o input
                    const rawId = chat.id.split('@')[0];
                    const element = document.createElement('div');
                    const isGroup = chat.isGroup ? ' (GRUPO)' : '';
                    element.className = 'p-2 my-1 bg-white hover:bg-blue-50 cursor-pointer rounded-md transition duration-100 border-b border-gray-100';
                    element.innerHTML = `<span class="font-semibold">${chat.name}</span>${isGroup} <span class="text-xs text-gray-500 ml-2">ID: ${rawId}</span>`;
                    element.onclick = () => {
                        chatIdInput.value = rawId;
                        // Feedback visual simples
                        chatIdInput.focus();
                        chatIdInput.classList.add('ring-2', 'ring-blue-500');
                        setTimeout(() => chatIdInput.classList.remove('ring-2', 'ring-blue-500'), 500);
                    };
                    chatListDiv.appendChild(element);
                });

            } catch (error) {
                console.error('Erro na requisi√ß√£o de chats:', error);
                chatListDiv.innerHTML = '<p class="text-red-600">Erro de rede/servidor ao listar chats.</p>';
            }
        }

        fetchChatsButton.addEventListener('click', fetchChats);


        // --- L√≥gica de Exporta√ß√£o (Submiss√£o) ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            messagePreview.textContent = 'Gerando arquivo TXT no servidor... Por favor, aguarde.';
            downloadLinkContainer.classList.add('hidden');

            const date = document.getElementById('dateInput').value;
            const rawChatId = chatIdInput.value;

            // Limpa o rawChatId e garante que √© apenas o n√∫mero
            const cleanChatId = rawChatId.replace(/\D/g, ''); 
            
            // Adiciona o sufixo @c.us/g.us para a API (Assumindo que √© contato individual se s√≥ tiver n√∫mero)
            let formattedChatId = cleanChatId ? `${cleanChatId}@c.us` : ''; 
            
            // Se o usu√°rio copiou um ID completo do grupo, n√£o adicionamos @c.us novamente
            if (rawChatId.includes('@g.us')) {
                formattedChatId = rawChatId;
            } else if (cleanChatId.length < 10) {
                // Se o ID for muito curto, mantemos o que foi digitado, mas geralmente esperamos um n√∫mero completo
                formattedChatId = rawChatId; 
            }


            const params = new URLSearchParams({
                date: date,
                chatId: formattedChatId
            }).toString();

            try {
                // 1. CHAMA A API PARA GERAR O ARQUIVO TXT NO SERVIDOR
                const response = await fetch(`${API_URL}/export?${params}`);
                const result = await response.json();

                if (response.status !== 200 || !result.success) {
                    messagePreview.textContent = `[ERRO] ${result.message || 'Falha desconhecida na exporta√ß√£o.'}`;
                    messagePreview.classList.add('text-red-400');
                    return;
                }
                
                const filename = result.filename;
                
                // 2. CONFIGURA O LINK DE DOWNLOAD
                downloadLink.href = `${API_URL}/${filename}`;
                downloadLinkContainer.classList.remove('hidden');

                // 3. BUSCA O CONTE√öDO DO ARQUIVO PARA VISUALIZA√á√ÉO
                messagePreview.textContent = 'Arquivo gerado. Buscando conte√∫do para visualiza√ß√£o...';
                
                const fileResponse = await fetch(`${API_URL}/${filename}`);
                if (fileResponse.ok) {
                    const textContent = await fileResponse.text();
                    messagePreview.textContent = textContent;
                    messagePreview.classList.remove('text-red-400');
                } else {
                    messagePreview.textContent = `[ERRO] Arquivo TXT gerado, mas falhou ao buscar o conte√∫do para visualiza√ß√£o. Status: ${fileResponse.status}`;
                    messagePreview.classList.add('text-red-400');
                }
                
                // Feedback final
                setStatus(true, `‚úÖ Exporta√ß√£o conclu√≠da! ${result.message}`);

            } catch (error) {
                console.error('Erro de exporta√ß√£o:', error);
                messagePreview.textContent = `[ERRO GERAL] Falha na comunica√ß√£o com a API: ${error.message}`;
                messagePreview.classList.add('text-red-400');
            } finally {
                setLoading(false);
            }
        });


        // --- Verifica√ß√£o de Status Inicial ---

        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                
                if (data.ready) {
                    setStatus(true, '‚úÖ API PRONTA. WhatsApp conectado.');
                } else {
                    setStatus(false, '‚ö†Ô∏è API AGUARDANDO CONEX√ÉO. Verifique o QR Code no terminal.');
                    // Tenta checar novamente em 3 segundos se n√£o estiver pronto
                    setTimeout(checkStatus, 3000); 
                }
            } catch (error) {
                setStatus(false, '‚ùå ERRO DE CONEX√ÉO. Servidor Node.js n√£o est√° rodando em http://localhost:3000.');
                // Tenta checar novamente em 5 segundos
                setTimeout(checkStatus, 5000); 
            }
        }

        // Inicializa a verifica√ß√£o
        checkStatus();
    </script>
</body>
</html>
